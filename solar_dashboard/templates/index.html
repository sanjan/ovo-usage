<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OVO Energy Solar Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #0d1117;
            --bg-card: #161b22;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-sun: #fbbf24;
            --accent-sun-glow: rgba(251, 191, 36, 0.2);
            --accent-night: #60a5fa;
            --accent-export: #34d399;
            --accent-consumption: #f87171;
            --gradient-sun: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            --gradient-night: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            --gradient-export: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-pattern {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(251, 191, 36, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(52, 211, 153, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(96, 165, 250, 0.04) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem 0;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .logo-icon {
            width: 56px;
            height: 56px;
            background: var(--gradient-sun);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 0 40px var(--accent-sun-glow);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        /* Setup Panel */
        .setup-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .setup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .setup-grid { grid-template-columns: 1fr; }
        }

        .setup-section h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-area:hover, .file-upload-area.dragover {
            border-color: var(--accent-sun);
            background: rgba(251, 191, 36, 0.05);
        }

        .file-upload-area.has-file {
            border-color: var(--accent-export);
            background: rgba(52, 211, 153, 0.05);
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .file-upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .file-upload-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .file-name {
            color: var(--accent-export);
            font-weight: 500;
            margin-top: 0.5rem;
        }

        /* Location Search */
        .location-search {
            position: relative;
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.875rem 1rem;
            padding-left: 2.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            border-color: var(--accent-sun);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .search-icon {
            position: absolute;
            left: 0.875rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-top: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .search-results.visible {
            display: block;
        }

        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: rgba(251, 191, 36, 0.1);
        }

        .search-result-locality {
            font-weight: 500;
        }

        .search-result-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .current-location {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .current-location .label {
            color: var(--text-secondary);
        }

        .current-location .value {
            color: var(--accent-export);
            font-weight: 500;
        }

        /* Analyze Button */
        .analyze-btn {
            display: block;
            width: 100%;
            padding: 1rem 2rem;
            margin-top: 1.5rem;
            background: var(--gradient-sun);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px var(--accent-sun-glow);
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .stat-card.sunlight { border-left: 3px solid var(--accent-sun); }
        .stat-card.night { border-left: 3px solid var(--accent-night); }
        .stat-card.export { border-left: 3px solid var(--accent-export); }
        .stat-card.total { border-left: 3px solid var(--accent-consumption); }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 500;
        }

        .stat-value.sunlight { color: var(--accent-sun); }
        .stat-value.night { color: var(--accent-night); }
        .stat-value.export { color: var(--accent-export); }
        .stat-value.total { color: var(--accent-consumption); }

        .stat-unit {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-left: 0.25rem;
        }

        .stat-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* Charts */
        .charts-section {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .chart-row { grid-template-columns: 1fr; }
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            overflow: hidden;
        }

        .chart-card.full-width { grid-column: 1 / -1; }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-container { width: 100%; height: 350px; }
        .chart-container.tall { height: 450px; }

        /* Legend */
        .legend {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-dot.sunlight { background: var(--accent-sun); }
        .legend-dot.night { background: var(--accent-night); }
        .legend-dot.export { background: var(--accent-export); }

        /* Battery Section */
        .battery-section {
            margin-top: 3rem;
            padding-top: 3rem;
            border-top: 1px solid var(--border);
        }

        .section-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .section-header h2 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .section-header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .battery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .battery-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.75rem;
            position: relative;
            overflow: hidden;
        }

        .battery-card.recommended {
            border-color: var(--accent-export);
            box-shadow: 0 0 30px rgba(52, 211, 153, 0.15);
        }

        .battery-card.recommended::before {
            content: '‚òÖ RECOMMENDED';
            position: absolute;
            top: 0; right: 0;
            background: var(--accent-export);
            color: #000;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.35rem 0.75rem;
            border-radius: 0 16px 0 8px;
        }

        .battery-card-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .battery-size {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .battery-size span {
            font-size: 1.25rem;
            color: var(--text-secondary);
        }

        .battery-coverage {
            font-size: 0.95rem;
            color: var(--accent-export);
            margin-bottom: 1rem;
        }

        .battery-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .battery-details li {
            margin-bottom: 0.35rem;
            list-style: none;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .battery-details li::before {
            content: '‚Üí';
            color: var(--accent-export);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .metric-value.highlight-sun { color: var(--accent-sun); }
        .metric-value.highlight-night { color: var(--accent-night); }
        .metric-value.highlight-export { color: var(--accent-export); }

        .insight-box {
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.1) 0%, rgba(52, 211, 153, 0.05) 100%);
            border: 1px solid rgba(52, 211, 153, 0.3);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin-top: 1.5rem;
        }

        .insight-box h4 {
            color: var(--accent-export);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .insight-box p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .progress-bar-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            height: 24px;
            overflow: hidden;
            margin-top: 0.75rem;
        }

        .progress-bar {
            height: 100%;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: #000;
            transition: width 0.5s ease;
        }

        .progress-bar.green { background: var(--accent-export); }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            gap: 1.5rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-sun);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { color: var(--text-secondary); font-size: 1.1rem; }
        .loading-subtext { color: var(--text-secondary); font-size: 0.875rem; opacity: 0.7; }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        footer a {
            color: var(--accent-sun);
            text-decoration: none;
        }

        .hidden { display: none !important; }

        /* Rate Inputs */
        .rate-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .rate-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .rate-input-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .rate-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rate-input {
            flex: 1;
            padding: 0.625rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'JetBrains Mono', monospace;
            outline: none;
            width: 100%;
        }

        .rate-input:focus {
            border-color: var(--accent-sun);
        }

        .rate-unit {
            color: var(--text-secondary);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        /* ROI Table */
        .roi-table-container {
            overflow-x: auto;
            margin: 1.5rem 0;
        }

        .roi-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .roi-table th,
        .roi-table td {
            padding: 0.875rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .roi-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .roi-table tr:hover {
            background: rgba(251, 191, 36, 0.05);
        }

        .roi-table tr.recommended {
            background: rgba(52, 211, 153, 0.1);
        }

        .roi-table .highlight {
            color: var(--accent-export);
            font-weight: 500;
        }

        .roi-table .money {
            font-family: 'JetBrains Mono', monospace;
        }

        .roi-table .years {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-sun);
        }

        .roi-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--accent-export);
            color: #000;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        /* Date Range Selector */
        .date-range-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .date-range-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .date-range-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .date-range-inputs {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .date-input {
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            outline: none;
        }

        .date-input:focus {
            border-color: var(--accent-sun);
        }

        .date-separator {
            color: var(--text-secondary);
        }

        .date-range-btn {
            padding: 0.5rem 1rem;
            background: var(--gradient-sun);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .date-range-btn:hover {
            transform: translateY(-1px);
        }

        .date-range-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* Toggle Switch */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            margin-left: 1rem;
            padding-left: 1rem;
            border-left: 1px solid var(--border);
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-slider {
            width: 36px;
            height: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            position: relative;
            transition: background 0.2s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: var(--text-secondary);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s, background 0.2s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--accent-sun);
            border-color: var(--accent-sun);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(16px);
            background: #000;
        }

        .toggle-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .toggle-switch input:checked ~ .toggle-label {
            color: var(--accent-sun);
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">‚òÄÔ∏è</div>
                <h1>OVO Energy Solar Dashboard</h1>
            </div>
            <p class="subtitle">Analyze your solar usage patterns & get battery recommendations</p>
        </header>

        <!-- Setup Panel -->
        <div class="setup-panel" id="setup-panel">
            <div class="setup-grid">
                <div class="setup-section">
                    <h3>üìÅ Energy Data</h3>
                    <div class="file-upload-area" id="file-upload-area">
                        <input type="file" id="file-input" accept=".csv">
                        <div class="file-upload-icon">üìä</div>
                        <div class="file-upload-text">
                            Drop your OVO Energy CSV here or click to browse
                        </div>
                        <div class="file-name" id="file-name"></div>
                    </div>
                </div>

                <div class="setup-section">
                    <h3>üìç Your Location</h3>
                    <div class="location-search">
                        <div class="search-input-wrapper">
                            <span class="search-icon">üîç</span>
                            <input type="text" 
                                   class="search-input" 
                                   id="location-search" 
                                   placeholder="Search by postcode or suburb..."
                                   autocomplete="off">
                        </div>
                        <div class="search-results" id="search-results"></div>
                    </div>
                    <div class="current-location">
                        <span class="label">Current:</span>
                        <span class="value" id="current-location">{{ location.display_name }}</span>
                    </div>
                </div>
            </div>

            <button class="analyze-btn" id="analyze-btn" {% if not has_data %}disabled{% endif %}>
                üîç Analyze Energy Data
            </button>
        </div>

        <!-- Loading State -->
        <div class="loading hidden" id="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">Analyzing your energy data...</div>
            <div class="loading-subtext">Calculating sunlight hours for <span id="loading-location">your location</span></div>
        </div>

        <!-- Dashboard Content (hidden until data is loaded) -->
        <div id="dashboard" class="hidden">
            <div class="stats-grid">
                <div class="stat-card sunlight">
                    <div class="stat-label">‚òÄÔ∏è Paid Daytime Grid Import</div>
                    <div class="stat-value sunlight"><span id="stat-sunlight">--</span><span class="stat-unit">kWh</span></div>
                    <div class="stat-detail"><span id="stat-sunlight-pct">--</span>% of total (excl. free window)</div>
                </div>
                <div class="stat-card night">
                    <div class="stat-label">üåô Night Grid Import</div>
                    <div class="stat-value night"><span id="stat-night">--</span><span class="stat-unit">kWh</span></div>
                    <div class="stat-detail"><span id="stat-night-pct">--</span>% of total</div>
                </div>
                <div class="stat-card" style="border-left-color: #a855f7;" id="stat-card-free-window">
                    <div class="stat-label">üÜì Free Window (<span id="stat-free-window-times">11am-2pm</span>)</div>
                    <div class="stat-value" style="color: #a855f7;"><span id="stat-free-window">--</span><span class="stat-unit">kWh</span></div>
                    <div class="stat-detail"><span id="stat-free-window-pct">--</span>% of total (FREE!)</div>
                </div>
                <div class="stat-card export">
                    <div class="stat-label">‚ö° Solar Export</div>
                    <div class="stat-value export"><span id="stat-export">--</span><span class="stat-unit">kWh</span></div>
                    <div class="stat-detail">Sent to grid</div>
                </div>
                <div class="stat-card total">
                    <div class="stat-label">üìä Total Consumption</div>
                    <div class="stat-value total"><span id="stat-total">--</span><span class="stat-unit">kWh</span></div>
                    <div class="stat-detail">Over <span id="stat-days">--</span> days</div>
                </div>
            </div>

            <!-- Date Range Selector -->
            <div class="date-range-section">
                <div class="date-range-info">
                    <span class="date-range-label">üìÖ Analysis Period:</span>
                    <div class="date-range-inputs">
                        <input type="date" class="date-input" id="date-start">
                        <span class="date-separator">to</span>
                        <input type="date" class="date-input" id="date-end">
                    </div>
                    <button class="date-range-btn" id="apply-date-range">Apply Range</button>
                </div>
                <div class="date-range-hint" id="date-range-hint">
                    Data available: <span id="data-available-range">--</span>
                </div>
            </div>

            <div class="charts-section">
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title">üìà <span id="trends-chart-title">7-Day Rolling Average</span></div>
                        <div class="legend">
                            <div class="legend-item"><div class="legend-dot sunlight"></div>Daytime Grid Import</div>
                            <div class="legend-item"><div class="legend-dot night"></div>Night Grid Import</div>
                            <div class="legend-item"><div class="legend-dot export"></div>Solar Export</div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="trends-toggle">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Daily</span>
                            </label>
                        </div>
                    </div>
                    <div id="chart-trends" class="chart-container tall"></div>
                </div>

                <!-- Battery Simulation Chart -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title">üîã Battery Simulation - What If?</div>
                        <div class="chart-controls">
                            <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                                Battery Size:
                                <select id="sim-battery-size" style="background: var(--card-bg); border: 1px solid var(--border); color: var(--text); padding: 0.3rem 0.5rem; border-radius: 4px;">
                                    <option value="8">8 kWh (1 module)</option>
                                    <option value="16">16 kWh (2 modules)</option>
                                    <option value="24">24 kWh (3 modules)</option>
                                    <option value="32" selected>32 kWh (4 modules)</option>
                                    <option value="40">40 kWh (5 modules)</option>
                                    <option value="48">48 kWh (6 modules)</option>
                                    <option value="64">64 kWh (8 modules)</option>
                                    <option value="80">80 kWh (10 modules)</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    <div id="chart-battery-sim" class="chart-container tall"></div>
                    <div id="battery-sim-stats" style="display: flex; gap: 2rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 0.5rem; flex-wrap: wrap;">
                    </div>
                </div>

                <div class="chart-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">‚è∞ Hourly Usage Pattern</div>
                        </div>
                        <div id="chart-hourly" class="chart-container"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">üìÖ Monthly Breakdown</div>
                        </div>
                        <div id="chart-monthly" class="chart-container"></div>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title">üåÖ Daylight vs Generation Hours</div>
                        <div class="legend">
                            <div class="legend-item"><div class="legend-dot sunlight"></div>Theoretical Daylight</div>
                            <div class="legend-item"><div class="legend-dot export"></div>Actual Generation</div>
                        </div>
                    </div>
                    <div id="chart-daylight" class="chart-container"></div>
                </div>

                <div class="chart-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">ü•ß Usage Distribution</div>
                        </div>
                        <div id="chart-pie" class="chart-container"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">üìä Daily Stacked View</div>
                        </div>
                        <div id="chart-daily" class="chart-container"></div>
                    </div>
                </div>
            </div>

            <!-- Battery Recommendation Section -->
            <div class="battery-section">
                <div class="section-header">
                    <h2>üîã Battery Capacity Recommendation</h2>
                    <p>Based on your actual usage patterns and solar export data</p>
                </div>

                <div class="metrics-grid" id="battery-metrics"></div>
                <div class="battery-grid" id="battery-options"></div>

                <div class="chart-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">üìä Battery Size vs Night Coverage</div>
                        </div>
                        <div id="chart-battery-savings" class="chart-container"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">üìà Diminishing Returns Analysis</div>
                        </div>
                        <div id="chart-marginal" class="chart-container"></div>
                    </div>
                </div>

                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title">üå°Ô∏è Seasonal Analysis</div>
                    </div>
                    <div id="chart-seasonal" class="chart-container"></div>
                </div>

                <div class="insight-box" id="battery-insight"></div>

                <!-- ROI Analysis Section -->
                <div class="section-header" style="margin-top: 3rem;">
                    <h2>üí∞ Return on Investment Analysis</h2>
                    <p>Estimate payback period based on your electricity rates</p>
                </div>

                <div class="rate-inputs">
                    <div class="rate-input-group">
                        <label>Peak Rate</label>
                        <div class="rate-input-wrapper">
                            <input type="number" class="rate-input" id="rate-peak" value="44" min="0" max="100" step="0.01">
                            <span class="rate-unit">c/kWh</span>
                        </div>
                    </div>
                    <div class="rate-input-group">
                        <label>Off-Peak Rate</label>
                        <div class="rate-input-wrapper">
                            <input type="number" class="rate-input" id="rate-offpeak" value="24.83" min="0" max="100" step="0.01">
                            <span class="rate-unit">c/kWh</span>
                        </div>
                    </div>
                    <div class="rate-input-group">
                        <label>Solar Feed-in Tariff</label>
                        <div class="rate-input-wrapper">
                            <input type="number" class="rate-input" id="rate-feedin" value="3.3" min="0" max="50" step="0.1">
                            <span class="rate-unit">c/kWh</span>
                        </div>
                    </div>
                    <div class="rate-input-group">
                        <label>Battery Cost (installed)</label>
                        <div class="rate-input-wrapper">
                            <input type="number" class="rate-input" id="rate-battery-cost" value="540" min="0" max="2000" step="10">
                            <span class="rate-unit">$/kWh</span>
                        </div>
                    </div>
                </div>

                <div class="rate-inputs" style="margin-top: 1rem;">
                    <div class="rate-input-group" style="flex: 2;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="free-window-enabled" checked style="width: 18px; height: 18px; accent-color: var(--accent-export);">
                            Free Power Window
                        </label>
                        <div class="rate-input-wrapper" style="margin-top: 0.5rem;">
                            <input type="time" class="rate-input" id="free-window-start" value="11:00" style="width: auto;">
                            <span class="rate-unit">to</span>
                            <input type="time" class="rate-input" id="free-window-end" value="14:00" style="width: auto;">
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            Grid usage during this window won't count towards battery savings
                        </div>
                    </div>
                </div>
                <button class="analyze-btn" id="update-roi-btn" style="margin-top: 0; max-width: 300px;">
                    üí∞ Update ROI Calculation
                </button>

                <div class="roi-table-container">
                    <table class="roi-table" id="roi-table">
                        <thead>
                            <tr>
                                <th>Battery Size</th>
                                <th>Est. Cost</th>
                                <th>Daily Savings</th>
                                <th>Annual Savings</th>
                                <th>Payback Period</th>
                            </tr>
                        </thead>
                        <tbody id="roi-table-body"></tbody>
                    </table>
                </div>

                <div class="chart-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">üìâ Payback Timeline</div>
                        </div>
                        <div id="chart-payback" class="chart-container"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">üíµ Cumulative Savings Over 10 Years</div>
                        </div>
                        <div id="chart-cumulative" class="chart-container"></div>
                    </div>
                </div>

                <div class="insight-box" id="roi-insight"></div>
            </div>
        </div>

        <footer>
            <p>
                Sunrise/sunset data calculated using <a href="https://github.com/sffjunkie/astral" target="_blank">Astral</a> ‚Ä¢ 
                Postcode data from <a href="https://www.matthewproctor.com/australian_postcodes" target="_blank">Matthew Proctor</a>
            </p>
        </footer>
    </div>

    <script>
        // State
        let hasFile = {{ 'true' if has_data else 'false' }};
        let currentLocation = {{ location | tojson }};
        let currentBatteryData = null; // Store for ROI recalculations
        let dateRange = { start: null, end: null, solarStart: null, dataEnd: null };
        let trendsData = { daily: null, rolling: null }; // Store for toggle

        // Colors
        const colors = {
            sunlight: '#fbbf24',
            night: '#60a5fa',
            export: '#34d399',
            consumption: '#f87171',
            grid: '#30363d',
            text: '#8b949e',
            bg: '#161b22'
        };

        const plotlyLayout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'DM Sans, sans-serif', color: colors.text },
            margin: { t: 20, r: 20, b: 50, l: 60 },
            xaxis: { gridcolor: colors.grid, zerolinecolor: colors.grid, tickfont: { size: 11 } },
            yaxis: { gridcolor: colors.grid, zerolinecolor: colors.grid, tickfont: { size: 11 }, fixedrange: true },
            hoverlabel: { bgcolor: colors.bg, bordercolor: colors.grid, font: { family: 'DM Sans, sans-serif' } },
            dragmode: 'zoom'  // Horizontal zoom only (y-axis is fixed)
        };

        const plotlyConfig = {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['lasso2d', 'select2d', 'zoom2d'],  // Remove box zoom button
            displaylogo: false
        };

        // Sync zoom across time-series charts
        const syncedCharts = ['chart-trends', 'chart-battery-sim'];
        let isSyncing = false;  // Prevent infinite loop
        
        function setupChartSync(chartId) {
            const chartDiv = document.getElementById(chartId);
            if (!chartDiv) return;
            
            chartDiv.on('plotly_relayout', function(eventData) {
                if (isSyncing) return;  // Skip if we're already syncing
                
                // Check if this is a zoom event (has xaxis range)
                const xRange = eventData['xaxis.range[0]'] !== undefined ? 
                    [eventData['xaxis.range[0]'], eventData['xaxis.range[1]']] : 
                    eventData['xaxis.range'];
                
                const isAutoRange = eventData['xaxis.autorange'];
                
                if (xRange || isAutoRange) {
                    isSyncing = true;
                    
                    // Apply same range to all other synced charts
                    syncedCharts.forEach(otherId => {
                        if (otherId !== chartId) {
                            const otherDiv = document.getElementById(otherId);
                            if (otherDiv && otherDiv.data) {
                                if (isAutoRange) {
                                    Plotly.relayout(otherId, { 'xaxis.autorange': true });
                                } else if (xRange) {
                                    Plotly.relayout(otherId, { 'xaxis.range': xRange });
                                }
                            }
                        }
                    });
                    
                    // Small delay before allowing next sync
                    setTimeout(() => { isSyncing = false; }, 100);
                }
            });
        }

        // File Upload
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileInput = document.getElementById('file-input');
        const fileName = document.getElementById('file-name');
        const analyzeBtn = document.getElementById('analyze-btn');

        fileUploadArea.addEventListener('click', () => fileInput.click());

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFileSelect(e.target.files[0]);
            }
        });

        async function handleFileSelect(file) {
            if (!file.name.endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    hasFile = true;
                    fileName.textContent = `‚úì ${result.filename}`;
                    fileUploadArea.classList.add('has-file');
                    analyzeBtn.disabled = false;
                } else {
                    alert('Error uploading file: ' + result.error);
                }
            } catch (error) {
                alert('Error uploading file: ' + error.message);
            }
        }

        // Location Search
        const locationSearch = document.getElementById('location-search');
        const searchResults = document.getElementById('search-results');
        const currentLocationEl = document.getElementById('current-location');
        let searchTimeout;

        locationSearch.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();

            if (query.length < 2) {
                searchResults.classList.remove('visible');
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/search-locations?q=${encodeURIComponent(query)}`);
                    const results = await response.json();

                    if (results.length > 0) {
                        searchResults.innerHTML = results.map(loc => `
                            <div class="search-result-item" data-location='${JSON.stringify(loc)}'>
                                <div class="search-result-locality">${loc.locality}</div>
                                <div class="search-result-details">${loc.state} ${loc.postcode}</div>
                            </div>
                        `).join('');
                        searchResults.classList.add('visible');
                    } else {
                        searchResults.classList.remove('visible');
                    }
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        });

        searchResults.addEventListener('click', async (e) => {
            const item = e.target.closest('.search-result-item');
            if (!item) return;

            const location = JSON.parse(item.dataset.location);

            try {
                const response = await fetch('/api/location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ postcode: location.postcode })
                });

                const result = await response.json();

                if (result.success) {
                    currentLocation = result.location;
                    currentLocationEl.textContent = result.location.display_name;
                    locationSearch.value = '';
                    searchResults.classList.remove('visible');
                }
            } catch (error) {
                console.error('Error setting location:', error);
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.location-search')) {
                searchResults.classList.remove('visible');
            }
        });

        // Analyze Button
        analyzeBtn.addEventListener('click', loadData);

        async function loadData(useCustomDates = false) {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loading-location').textContent = currentLocation.display_name;

            try {
                // Build URL with parameters
                let url = '/api/data';
                const params = new URLSearchParams();
                
                if (useCustomDates && dateRange.start && dateRange.end) {
                    params.set('start_date', dateRange.start);
                    params.set('end_date', dateRange.end);
                }
                
                // Free window settings
                const freeWindowEnabled = document.getElementById('free-window-enabled').checked;
                params.set('free_window_enabled', freeWindowEnabled);
                if (freeWindowEnabled) {
                    params.set('free_window_start', document.getElementById('free-window-start').value);
                    params.set('free_window_end', document.getElementById('free-window-end').value);
                }
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    document.getElementById('loading').classList.add('hidden');
                    return;
                }

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');

                // Update date range state and UI
                dateRange.solarStart = data.stats.solar_start;
                dateRange.dataEnd = data.stats.data_end;
                dateRange.start = data.stats.analysis_start;
                dateRange.end = data.stats.analysis_end;
                
                document.getElementById('date-start').value = data.stats.analysis_start;
                document.getElementById('date-end').value = data.stats.analysis_end;
                document.getElementById('date-start').min = data.stats.solar_start;
                document.getElementById('date-start').max = data.stats.data_end;
                document.getElementById('date-end').min = data.stats.solar_start;
                document.getElementById('date-end').max = data.stats.data_end;
                document.getElementById('data-available-range').textContent = 
                    `${data.stats.solar_start} to ${data.stats.data_end}`;

                updateStats(data.stats);
                
                // Store trends data for toggle
                trendsData = {
                    daily: data.daily,
                    rolling: data.trends
                };
                renderTrendsChart(trendsData, document.getElementById('trends-toggle').checked ? 'daily' : 'rolling');
                
                // Store daily data for battery simulation
                globalDailyData = data.daily;
                const simBatterySize = parseInt(document.getElementById('sim-battery-size').value);
                renderBatterySimulation(data.daily, simBatterySize);
                
                renderHourlyChart(data.hourly);
                renderMonthlyChart(data.monthly);
                renderDaylightChart(data.daylight);
                renderPieChart(data.stats);
                renderDailyChart(data.daily);
                renderBatteryMetrics(data.battery);
                renderBatteryOptions(data.battery);
                renderBatterySavingsChart(data.battery);
                renderMarginalBenefitChart(data.battery);
                renderSeasonalChart(data.battery);
                renderBatteryInsight(data.battery);
                
                // ROI Analysis
                currentBatteryData = data.battery;
                renderROITable(data.battery);
                renderPaybackChart(data.battery);
                renderCumulativeSavingsChart(data.battery);
                renderROIInsight(data.battery);

            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data: ' + error.message);
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function updateStats(stats) {
            // Show paid sunlight (excluding free window) or total sunlight if not available
            const freeWindowEnabled = stats.free_window_enabled !== false;
            const paidSunlight = (freeWindowEnabled && stats.paid_sunlight_consumption !== undefined)
                ? stats.paid_sunlight_consumption 
                : stats.sunlight_consumption;
            document.getElementById('stat-sunlight').textContent = paidSunlight.toLocaleString();
            document.getElementById('stat-night').textContent = stats.night_consumption.toLocaleString();
            document.getElementById('stat-export').textContent = stats.total_exports.toLocaleString();
            document.getElementById('stat-total').textContent = stats.total_consumption.toLocaleString();
            document.getElementById('stat-days').textContent = stats.num_days;
            
            // Calculate paid sunlight percentage
            const paidSunlightPct = stats.total_consumption > 0 
                ? ((paidSunlight / stats.total_consumption) * 100).toFixed(1) 
                : 0;
            document.getElementById('stat-sunlight-pct').textContent = paidSunlightPct;
            document.getElementById('stat-night-pct').textContent = stats.night_pct;
            
            // Free window stats - show/hide based on whether enabled
            const freeWindowCard = document.getElementById('stat-card-free-window');
            if (freeWindowEnabled && stats.free_window_consumption > 0) {
                freeWindowCard.style.display = '';
                document.getElementById('stat-free-window').textContent = stats.free_window_consumption.toLocaleString();
                document.getElementById('stat-free-window-pct').textContent = stats.free_window_pct || 0;
                
                // Format times for display
                const formatTime = (timeStr) => {
                    const [h, m] = timeStr.split(':');
                    const hour = parseInt(h);
                    const ampm = hour >= 12 ? 'pm' : 'am';
                    const hour12 = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                    return `${hour12}${ampm}`;
                };
                const startTime = formatTime(stats.free_window_start || '11:00');
                const endTime = formatTime(stats.free_window_end || '14:00');
                document.getElementById('stat-free-window-times').textContent = `${startTime}-${endTime}`;
            } else {
                freeWindowCard.style.display = 'none';
            }
            
            // Update sunlight label based on free window
            const sunlightLabel = document.querySelector('.stat-card.sunlight .stat-label');
            sunlightLabel.textContent = freeWindowEnabled ? '‚òÄÔ∏è Paid Daytime Grid Import' : '‚òÄÔ∏è Daytime Grid Import';
        }

        function renderTrendsChart(data, mode = 'rolling') {
            const isDaily = mode === 'daily';
            const chartData = isDaily ? data.daily : data.rolling;
            
            const traces = [
                { 
                    x: chartData.dates, 
                    y: chartData.sunlight, 
                    name: 'Daytime Grid Import', 
                    type: 'scatter', 
                    mode: isDaily ? 'lines' : 'lines', 
                    line: { color: colors.sunlight, width: isDaily ? 1.5 : 2.5 }, 
                    fill: 'tozeroy', 
                    fillcolor: 'rgba(251, 191, 36, 0.1)' 
                },
                { 
                    x: chartData.dates, 
                    y: chartData.night, 
                    name: 'Night Grid Import', 
                    type: 'scatter', 
                    mode: isDaily ? 'lines' : 'lines', 
                    line: { color: colors.night, width: isDaily ? 1.5 : 2.5 } 
                },
                { 
                    x: chartData.dates, 
                    y: chartData.export, 
                    name: 'Solar Export', 
                    type: 'scatter', 
                    mode: isDaily ? 'lines' : 'lines', 
                    line: { color: colors.export, width: isDaily ? 1.5 : 2.5 } 
                }
            ];
            
            const yAxisTitle = isDaily ? 'kWh (daily)' : 'kWh (7-day avg)';
            document.getElementById('trends-chart-title').textContent = isDaily ? 'Daily Values' : '7-Day Rolling Average';
            
            Plotly.newPlot('chart-trends', traces, { 
                ...plotlyLayout, 
                showlegend: false, 
                yaxis: { ...plotlyLayout.yaxis, title: yAxisTitle }, 
                hovermode: 'x unified' 
            }, plotlyConfig);
            
            // Setup zoom sync with other time-series charts
            setupChartSync('chart-trends');
        }

        // Store daily data globally for battery simulation
        let globalDailyData = null;
        
        function simulateBattery(daily, batterySizeKwh) {
            const efficiency = 0.97; // Sigenergy efficiency
            const usableCapacity = batterySizeKwh * efficiency;
            
            const dates = daily.dates;
            const nightUsage = daily.night;
            const solarExport = daily.export;
            
            // Simulation results
            const simNightUsage = [];      // Night usage after battery discharge
            const simExport = [];          // Export after battery charging
            const batterySOC = [];         // State of charge at end of each day
            const batteryCharged = [];     // kWh charged each day
            const batteryDischarged = [];  // kWh discharged each day
            
            let currentSOC = 0; // Start with empty battery
            
            for (let i = 0; i < dates.length; i++) {
                const dayExport = solarExport[i] || 0;
                const dayNight = nightUsage[i] || 0;
                
                // Phase 1: Charge battery from solar export
                const availableToCharge = Math.min(dayExport, usableCapacity - currentSOC);
                const charged = availableToCharge;
                currentSOC += charged;
                
                // Phase 2: Discharge battery for night usage
                const availableToDischarge = Math.min(dayNight, currentSOC);
                const discharged = availableToDischarge;
                currentSOC -= discharged;
                
                // Store results
                simNightUsage.push(Math.max(0, dayNight - discharged));
                simExport.push(Math.max(0, dayExport - charged));
                batterySOC.push(currentSOC);
                batteryCharged.push(charged);
                batteryDischarged.push(discharged);
            }
            
            return {
                dates,
                originalNight: nightUsage,
                simNightUsage,
                originalExport: solarExport,
                simExport,
                batterySOC,
                batteryCharged,
                batteryDischarged,
                usableCapacity
            };
        }
        
        function renderBatterySimulation(daily, batterySizeKwh) {
            const sim = simulateBattery(daily, batterySizeKwh);
            
            // Calculate 7-day rolling averages for smoother visualization
            const rollingWindow = 7;
            const rolling = (arr) => {
                const result = [];
                for (let i = 0; i < arr.length; i++) {
                    if (i < rollingWindow - 1) {
                        result.push(null);
                    } else {
                        const slice = arr.slice(i - rollingWindow + 1, i + 1);
                        result.push(slice.reduce((a, b) => a + b, 0) / rollingWindow);
                    }
                }
                return result;
            };
            
            const traces = [
                {
                    x: sim.dates,
                    y: rolling(sim.originalNight),
                    name: 'Night Grid Import (Original)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: colors.night, width: 2, dash: 'dot' },
                    opacity: 0.5
                },
                {
                    x: sim.dates,
                    y: rolling(sim.simNightUsage),
                    name: 'Night Grid Import (With Battery)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: colors.night, width: 2.5 },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(96, 165, 250, 0.2)'
                },
                {
                    x: sim.dates,
                    y: rolling(sim.originalExport),
                    name: 'Solar Export (Original)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: colors.export, width: 2, dash: 'dot' },
                    opacity: 0.5
                },
                {
                    x: sim.dates,
                    y: rolling(sim.simExport),
                    name: 'Solar Export (With Battery)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: colors.export, width: 2.5 }
                },
                {
                    x: sim.dates,
                    y: rolling(sim.batterySOC),
                    name: 'Battery SOC',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#a855f7', width: 2 },
                    yaxis: 'y2'
                }
            ];
            
            Plotly.newPlot('chart-battery-sim', traces, {
                ...plotlyLayout,
                showlegend: true,
                legend: { x: 0, y: 1.15, orientation: 'h', font: { size: 11 } },
                yaxis: { ...plotlyLayout.yaxis, title: 'kWh (7-day avg)' },
                yaxis2: {
                    title: 'Battery SOC (kWh)',
                    overlaying: 'y',
                    side: 'right',
                    showgrid: false,
                    color: '#a855f7',
                    range: [0, sim.usableCapacity * 1.1],
                    fixedrange: true
                },
                hovermode: 'x unified'
            }, plotlyConfig);
            
            // Setup zoom sync with other time-series charts
            setupChartSync('chart-battery-sim');
            
            // Calculate stats
            const totalOriginalNight = sim.originalNight.reduce((a, b) => a + b, 0);
            const totalSimNight = sim.simNightUsage.reduce((a, b) => a + b, 0);
            const totalOriginalExport = sim.originalExport.reduce((a, b) => a + b, 0);
            const totalSimExport = sim.simExport.reduce((a, b) => a + b, 0);
            const totalCharged = sim.batteryCharged.reduce((a, b) => a + b, 0);
            const totalDischarged = sim.batteryDischarged.reduce((a, b) => a + b, 0);
            const avgSOC = sim.batterySOC.reduce((a, b) => a + b, 0) / sim.batterySOC.length;
            
            const nightReduction = ((totalOriginalNight - totalSimNight) / totalOriginalNight * 100).toFixed(1);
            const exportReduction = ((totalOriginalExport - totalSimExport) / totalOriginalExport * 100).toFixed(1);
            
            document.getElementById('battery-sim-stats').innerHTML = `
                <div style="flex: 1; min-width: 150px;">
                    <div style="color: var(--text-secondary); font-size: 0.8rem;">Night Grid Usage</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: ${colors.night};">
                        ${totalSimNight.toFixed(0)} kWh
                        <span style="font-size: 0.85rem; color: var(--accent-export);">‚Üì${nightReduction}%</span>
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.75rem;">was ${totalOriginalNight.toFixed(0)} kWh</div>
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <div style="color: var(--text-secondary); font-size: 0.8rem;">Solar Exported</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: ${colors.export};">
                        ${totalSimExport.toFixed(0)} kWh
                        <span style="font-size: 0.85rem; color: var(--text-secondary);">‚Üì${exportReduction}%</span>
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.75rem;">was ${totalOriginalExport.toFixed(0)} kWh</div>
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <div style="color: var(--text-secondary); font-size: 0.8rem;">Self-Consumed via Battery</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: #a855f7;">${totalDischarged.toFixed(0)} kWh</div>
                    <div style="color: var(--text-secondary); font-size: 0.75rem;">${(totalDischarged / sim.dates.length).toFixed(1)} kWh/day avg</div>
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <div style="color: var(--text-secondary); font-size: 0.8rem;">Avg Battery Level</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: #a855f7;">${avgSOC.toFixed(1)} kWh</div>
                    <div style="color: var(--text-secondary); font-size: 0.75rem;">${(avgSOC / sim.usableCapacity * 100).toFixed(0)}% of ${sim.usableCapacity.toFixed(0)} kWh</div>
                </div>
            `;
        }

        function renderHourlyChart(hourly) {
            const hourLabels = hourly.hours.map(h => `${h.toString().padStart(2, '0')}:00`);
            const traces = [
                { x: hourLabels, y: hourly.consumption, name: 'Grid Consumption', type: 'bar', marker: { color: hourly.hours.map(h => h >= 6 && h <= 18 ? colors.sunlight : colors.night), opacity: 0.8 } },
                { x: hourLabels, y: hourly.export, name: 'Solar Export', type: 'bar', marker: { color: colors.export, opacity: 0.8 } }
            ];
            Plotly.newPlot('chart-hourly', traces, { ...plotlyLayout, barmode: 'group', showlegend: true, legend: { x: 0, y: 1.1, orientation: 'h' }, xaxis: { ...plotlyLayout.xaxis, tickangle: -45, type: 'category' }, yaxis: { ...plotlyLayout.yaxis, title: 'Avg kWh' } }, plotlyConfig);
        }

        function renderMonthlyChart(monthly) {
            const traces = [
                { x: monthly.months, y: monthly.sunlight, name: 'Sunlight', type: 'bar', marker: { color: colors.sunlight } },
                { x: monthly.months, y: monthly.night, name: 'Night', type: 'bar', marker: { color: colors.night } },
                { x: monthly.months, y: monthly.export, name: 'Export', type: 'bar', marker: { color: colors.export } }
            ];
            Plotly.newPlot('chart-monthly', traces, { ...plotlyLayout, barmode: 'group', showlegend: true, legend: { x: 0, y: 1.1, orientation: 'h' }, yaxis: { ...plotlyLayout.yaxis, title: 'kWh' } }, plotlyConfig);
        }

        function renderDaylightChart(daylight) {
            const traces = [
                { 
                    x: daylight.months, 
                    y: daylight.theoretical, 
                    name: 'Theoretical Daylight', 
                    type: 'scatter', 
                    mode: 'lines+markers',
                    line: { color: colors.sunlight, width: 2.5 },
                    marker: { size: 8 },
                    hovertemplate: '%{y:.1f} hours<extra>Daylight</extra>'
                },
                { 
                    x: daylight.months, 
                    y: daylight.actual, 
                    name: 'Actual Generation', 
                    type: 'scatter', 
                    mode: 'lines+markers',
                    line: { color: colors.export, width: 2.5 },
                    marker: { size: 8 },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(52, 211, 153, 0.1)',
                    hovertemplate: '%{y:.1f} hours<extra>Generation</extra>'
                }
            ];
            
            // Calculate efficiency percentage for annotation
            const avgTheoretical = daylight.theoretical.reduce((a, b) => a + b, 0) / daylight.theoretical.length;
            const avgActual = daylight.actual.reduce((a, b) => a + b, 0) / daylight.actual.length;
            const efficiency = ((avgActual / avgTheoretical) * 100).toFixed(0);
            
            Plotly.newPlot('chart-daylight', traces, { 
                ...plotlyLayout, 
                showlegend: false,
                xaxis: { ...plotlyLayout.xaxis, type: 'category' },
                yaxis: { ...plotlyLayout.yaxis, title: 'Hours per Day' },
                annotations: [{
                    x: 0.98,
                    y: 0.98,
                    xref: 'paper',
                    yref: 'paper',
                    text: `Generation captures ${efficiency}% of daylight`,
                    showarrow: false,
                    font: { color: colors.export, size: 12 },
                    xanchor: 'right'
                }]
            }, plotlyConfig);
        }

        function renderPieChart(stats) {
            const traces = [{ values: [stats.sunlight_consumption, stats.night_consumption], labels: ['Daytime Grid Import', 'Night Grid Import'], type: 'pie', hole: 0.55, marker: { colors: [colors.sunlight, colors.night] }, textinfo: 'percent', textfont: { color: '#fff', size: 14 }, hovertemplate: '%{label}<br>%{value:.1f} kWh<br>%{percent}<extra></extra>' }];
            Plotly.newPlot('chart-pie', traces, { ...plotlyLayout, showlegend: true, legend: { x: 0.5, y: -0.1, xanchor: 'center', orientation: 'h' }, annotations: [{ text: `${stats.total_consumption.toLocaleString()}<br>kWh`, x: 0.5, y: 0.5, font: { size: 18, color: colors.text }, showarrow: false }] }, plotlyConfig);
        }

        function renderDailyChart(daily) {
            const sampleSize = Math.min(60, daily.dates.length);
            const startIdx = daily.dates.length - sampleSize;
            const traces = [
                { x: daily.dates.slice(startIdx), y: daily.sunlight.slice(startIdx), name: 'Sunlight', type: 'bar', marker: { color: colors.sunlight } },
                { x: daily.dates.slice(startIdx), y: daily.night.slice(startIdx), name: 'Night', type: 'bar', marker: { color: colors.night } }
            ];
            Plotly.newPlot('chart-daily', traces, { ...plotlyLayout, barmode: 'stack', showlegend: true, legend: { x: 0, y: 1.1, orientation: 'h' }, xaxis: { ...plotlyLayout.xaxis, title: 'Last 60 days' }, yaxis: { ...plotlyLayout.yaxis, title: 'kWh' } }, plotlyConfig);
        }

        function renderBatteryMetrics(battery) {
            const m = battery.metrics;
            document.getElementById('battery-metrics').innerHTML = `
                <div class="metric-item"><div class="metric-label">Avg Night Grid Import</div><div class="metric-value highlight-night">${m.avg_night_consumption} kWh</div></div>
                <div class="metric-item"><div class="metric-label">Peak Night (90th %ile)</div><div class="metric-value highlight-night">${m.p90_night_consumption} kWh</div></div>
                <div class="metric-item"><div class="metric-label">Avg Daily Export</div><div class="metric-value highlight-export">${m.avg_daily_export} kWh</div></div>
                <div class="metric-item"><div class="metric-label">Storable Energy</div><div class="metric-value highlight-export">${m.avg_potential_storage} kWh</div></div>
                <div class="metric-item"><div class="metric-label">Winter Night Avg</div><div class="metric-value highlight-sun">${m.winter_night_avg} kWh</div></div>
                <div class="metric-item"><div class="metric-label">Summer Night Avg</div><div class="metric-value highlight-sun">${m.summer_night_avg} kWh</div></div>
            `;
        }

        function renderBatteryOptions(battery) {
            const rec = battery.recommendations;
            const metrics = battery.metrics;
            const analysis = battery.battery_analysis;
            
            // Percentile-based recommendations:
            // - Minimum: 90th percentile summer night usage
            // - Sweet Spot: 99th percentile summer night usage  
            // - Maximum: 90th percentile winter night usage
            const minimum = analysis.find(a => a.size_kwh === rec.minimum_kwh) || analysis[0];
            const sweetSpot = analysis.find(a => a.size_kwh === rec.sweet_spot_kwh) || analysis[2];
            const maximum = analysis.find(a => a.size_kwh === rec.maximum_kwh) || analysis[analysis.length - 1];
            
            document.getElementById('battery-options').innerHTML = `
                <div class="battery-card">
                    <div class="battery-card-title">Entry Level</div>
                    <div class="battery-size">${rec.minimum_kwh}<span> kWh</span></div>
                    <div class="battery-coverage">${minimum.summer_coverage_pct}% summer coverage</div>
                    <ul class="battery-details">
                        <li>Covers 90% of summer nights</li>
                        <li>Target: ${metrics.summer_night_p90} kWh/night</li>
                        <li>~${minimum.avg_daily_savings} kWh saved daily</li>
                    </ul>
                </div>
                <div class="battery-card recommended">
                    <div class="battery-card-title">Best Value ‚≠ê</div>
                    <div class="battery-size">${rec.sweet_spot_kwh}<span> kWh</span></div>
                    <div class="battery-coverage">${sweetSpot.summer_coverage_pct}% summer coverage</div>
                    <ul class="battery-details">
                        <li>Covers 99% of summer nights</li>
                        <li>Target: ${metrics.summer_night_p99} kWh/night</li>
                        <li>~${sweetSpot.avg_daily_savings} kWh saved daily</li>
                    </ul>
                </div>
                <div class="battery-card">
                    <div class="battery-card-title">Winter Ready</div>
                    <div class="battery-size">${rec.maximum_kwh}<span> kWh</span></div>
                    <div class="battery-coverage">${maximum.winter_coverage_pct}% winter coverage</div>
                    <ul class="battery-details">
                        <li>Covers 90% of winter nights</li>
                        <li>Target: ${metrics.winter_night_p90} kWh/night</li>
                        <li>~${maximum.avg_daily_savings} kWh saved daily</li>
                    </ul>
                </div>
            `;
        }

        function renderBatterySavingsChart(battery) {
            const analysis = battery.battery_analysis;
            const traces = [{ x: analysis.map(a => `${a.size_kwh} kWh`), y: analysis.map(a => a.night_coverage_pct), name: 'Night Coverage %', type: 'bar', marker: { color: analysis.map(a => a.size_kwh === battery.recommendations.sweet_spot_kwh ? colors.export : 'rgba(52, 211, 153, 0.5)') }, text: analysis.map(a => `${a.night_coverage_pct}%`), textposition: 'outside', textfont: { color: colors.text } }];
            Plotly.newPlot('chart-battery-savings', traces, { ...plotlyLayout, showlegend: false, xaxis: { ...plotlyLayout.xaxis, type: 'category' }, yaxis: { ...plotlyLayout.yaxis, title: 'Night Grid Import Covered (%)', range: [0, 110] }, annotations: [{ x: `${battery.recommendations.sweet_spot_kwh} kWh`, y: analysis.find(a => a.size_kwh === battery.recommendations.sweet_spot_kwh)?.night_coverage_pct || 0, text: '‚òÖ Best Value', showarrow: true, arrowhead: 2, arrowcolor: colors.export, font: { color: colors.export, size: 11 }, ax: 0, ay: -40 }] }, plotlyConfig);
        }

        function renderMarginalBenefitChart(battery) {
            const mb = battery.marginal_benefits;
            const traces = [{ x: mb.map(m => `${m.from_size}‚Üí${m.to_size} kWh`), y: mb.map(m => m.marginal_benefit), type: 'scatter', mode: 'lines+markers', line: { color: colors.sunlight, width: 3 }, marker: { size: 10, color: colors.sunlight }, fill: 'tozeroy', fillcolor: 'rgba(251, 191, 36, 0.1)' }];
            Plotly.newPlot('chart-marginal', traces, { ...plotlyLayout, showlegend: false, xaxis: { ...plotlyLayout.xaxis, type: 'category' }, yaxis: { ...plotlyLayout.yaxis, title: 'Marginal Benefit (kWh/kWh)' }, annotations: [{ x: 0.5, y: 1.05, xref: 'paper', yref: 'paper', text: 'Higher = better value per additional kWh', showarrow: false, font: { color: colors.text, size: 11 } }] }, plotlyConfig);
        }

        function renderSeasonalChart(battery) {
            const m = battery.metrics;
            const traces = [
                { x: ['Winter', 'Summer'], y: [m.winter_night_avg, m.summer_night_avg], name: 'Night Grid Import', type: 'bar', marker: { color: colors.night } },
                { x: ['Winter', 'Summer'], y: [m.winter_export_avg, m.summer_export_avg], name: 'Solar Export', type: 'bar', marker: { color: colors.export } }
            ];
            Plotly.newPlot('chart-seasonal', traces, { ...plotlyLayout, barmode: 'group', showlegend: true, legend: { x: 0, y: 1.1, orientation: 'h' }, xaxis: { ...plotlyLayout.xaxis, type: 'category' }, yaxis: { ...plotlyLayout.yaxis, title: 'Daily Average (kWh)' }, annotations: [
                { x: 'Winter', y: Math.max(m.winter_night_avg, m.winter_export_avg) + 1, text: m.winter_export_avg >= m.winter_night_avg ? '‚úì Export covers night' : '‚ö† Need more export', showarrow: false, font: { color: m.winter_export_avg >= m.winter_night_avg ? colors.export : colors.sunlight, size: 11 } },
                { x: 'Summer', y: Math.max(m.summer_night_avg, m.summer_export_avg) + 1, text: m.summer_export_avg >= m.summer_night_avg ? '‚úì Export covers night' : '‚ö† Need more export', showarrow: false, font: { color: m.summer_export_avg >= m.summer_night_avg ? colors.export : colors.sunlight, size: 11 } }
            ] }, plotlyConfig);
        }

        function renderBatteryInsight(battery) {
            const rec = battery.recommendations;
            const m = battery.metrics;
            const analysis = battery.battery_analysis;
            const sweetSpotAnalysis = analysis.find(a => a.size_kwh === rec.sweet_spot_kwh);
            const annualSavings = sweetSpotAnalysis ? (sweetSpotAnalysis.avg_daily_savings * 365).toFixed(0) : '--';
            const exportCaptured = m.avg_daily_export > 0 ? ((sweetSpotAnalysis?.avg_daily_savings / m.avg_daily_export) * 100).toFixed(0) : '--';
            const winterChallenge = m.winter_export_avg < m.winter_night_avg;

            document.getElementById('battery-insight').innerHTML = `
                <h4>üí° Key Insights</h4>
                <p>Based on your usage patterns, a <strong>${rec.sweet_spot_kwh} kWh battery</strong> offers the best value. It would capture approximately <strong>${exportCaptured}%</strong> of your daily solar export and save around <strong>${annualSavings} kWh per year</strong> from grid imports.</p>
                <p style="margin-top: 0.75rem;">${winterChallenge 
                    ? `<span style="color: ${colors.sunlight}">‚ö† Winter months show lower solar export than night usage.</span> Consider a slightly larger battery for year-round coverage, or accept lower winter self-sufficiency.`
                    : `<span style="color: ${colors.export}">‚úì Your solar export exceeds night usage in both seasons.</span> A ${rec.sweet_spot_kwh} kWh battery should provide excellent year-round coverage.`
                }</p>
                <div class="progress-bar-container" style="margin-top: 1rem;"><div class="progress-bar green" style="width: ${sweetSpotAnalysis?.night_coverage_pct || 0}%">${sweetSpotAnalysis?.night_coverage_pct || 0}% night usage covered</div></div>
            `;
        }

        // ROI Analysis Functions
        function getRates() {
            const peak = parseFloat(document.getElementById('rate-peak').value) / 100; // Convert c to $
            const offpeak = parseFloat(document.getElementById('rate-offpeak').value) / 100;
            const feedIn = parseFloat(document.getElementById('rate-feedin').value) / 100;
            // Use weighted average: assume 60% peak, 40% off-peak for evening usage
            const avgUsage = (peak * 0.6) + (offpeak * 0.4);
            return {
                peak,
                offpeak,
                feedIn,
                usage: avgUsage,
                batteryCost: parseFloat(document.getElementById('rate-battery-cost').value)
            };
        }

        function calculateROI(battery) {
            const rates = getRates();
            const analysis = battery.battery_analysis;
            const sweetSpotSize = battery.recommendations.sweet_spot_kwh;
            
            // Calculate ROI for each battery size
            return analysis.map(a => {
                const batteryCost = a.size_kwh * rates.batteryCost;
                // Savings = kWh shifted from export to self-use √ó (usage rate - feed-in rate)
                const dailySavingsDollars = a.avg_daily_savings * (rates.usage - rates.feedIn);
                const annualSavings = dailySavingsDollars * 365;
                const paybackYears = annualSavings > 0 ? batteryCost / annualSavings : Infinity;
                
                return {
                    size_kwh: a.size_kwh,
                    battery_cost: batteryCost,
                    daily_savings_kwh: a.avg_daily_savings,
                    daily_savings_dollars: dailySavingsDollars,
                    annual_savings: annualSavings,
                    payback_years: paybackYears,
                    is_recommended: a.size_kwh === sweetSpotSize,
                    night_coverage_pct: a.night_coverage_pct
                };
            });
        }

        function renderROITable(battery) {
            const roiData = calculateROI(battery);
            const tbody = document.getElementById('roi-table-body');
            
            tbody.innerHTML = roiData.map(r => `
                <tr class="${r.is_recommended ? 'recommended' : ''}">
                    <td>
                        ${r.size_kwh} kWh
                        ${r.is_recommended ? '<span class="roi-badge">RECOMMENDED</span>' : ''}
                    </td>
                    <td class="money">$${r.battery_cost.toLocaleString()}</td>
                    <td class="money">$${r.daily_savings_dollars.toFixed(2)}</td>
                    <td class="money highlight">$${r.annual_savings.toFixed(0)}</td>
                    <td class="years">${r.payback_years < 100 ? r.payback_years.toFixed(1) + ' years' : 'N/A'}</td>
                </tr>
            `).join('');
        }

        function renderPaybackChart(battery) {
            const roiData = calculateROI(battery);
            const sweetSpotSize = battery.recommendations.sweet_spot_kwh;
            
            const traces = [{
                x: roiData.map(r => `${r.size_kwh} kWh`),
                y: roiData.map(r => Math.min(r.payback_years, 25)),
                type: 'bar',
                marker: {
                    color: roiData.map(r => r.is_recommended ? colors.export : 'rgba(52, 211, 153, 0.5)')
                },
                text: roiData.map(r => r.payback_years < 25 ? `${r.payback_years.toFixed(1)}y` : '>25y'),
                textposition: 'outside',
                textfont: { color: colors.text }
            }];
            
            Plotly.newPlot('chart-payback', traces, {
                ...plotlyLayout,
                showlegend: false,
                xaxis: { ...plotlyLayout.xaxis, type: 'category' },
                yaxis: { ...plotlyLayout.yaxis, title: 'Years to Payback', range: [0, Math.min(Math.max(...roiData.map(r => r.payback_years)) * 1.2, 30)] },
                annotations: [{
                    x: `${sweetSpotSize} kWh`,
                    y: roiData.find(r => r.is_recommended)?.payback_years || 0,
                    text: '‚òÖ Best Value',
                    showarrow: true,
                    arrowhead: 2,
                    arrowcolor: colors.export,
                    font: { color: colors.export, size: 11 },
                    ax: 0,
                    ay: -40
                }]
            }, plotlyConfig);
        }

        function renderCumulativeSavingsChart(battery) {
            const roiData = calculateROI(battery);
            const years = Array.from({length: 11}, (_, i) => i); // 0-10 years
            const sweetSpotSize = battery.recommendations.sweet_spot_kwh;
            
            // Select a few key battery sizes to show
            const sizesToShow = [roiData[0], roiData.find(r => r.is_recommended), roiData[roiData.length - 1]].filter(Boolean);
            const uniqueSizes = [...new Map(sizesToShow.map(r => [r.size_kwh, r])).values()];
            
            const traces = uniqueSizes.map((r, idx) => {
                const cumulativeSavings = years.map(y => (r.annual_savings * y) - r.battery_cost);
                return {
                    x: years,
                    y: cumulativeSavings,
                    name: `${r.size_kwh} kWh`,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { 
                        width: r.is_recommended ? 3 : 2,
                        dash: r.is_recommended ? 'solid' : 'dot'
                    },
                    marker: { size: r.is_recommended ? 8 : 6 }
                };
            });
            
            // Add break-even line
            traces.push({
                x: [0, 10],
                y: [0, 0],
                name: 'Break-even',
                type: 'scatter',
                mode: 'lines',
                line: { color: colors.text, width: 1, dash: 'dash' },
                showlegend: false
            });
            
            Plotly.newPlot('chart-cumulative', traces, {
                ...plotlyLayout,
                showlegend: true,
                legend: { x: 0, y: 1.15, orientation: 'h' },
                xaxis: { ...plotlyLayout.xaxis, title: 'Years', dtick: 1 },
                yaxis: { ...plotlyLayout.yaxis, title: 'Net Savings ($)', tickprefix: '$' }
            }, plotlyConfig);
        }

        function renderROIInsight(battery) {
            const roiData = calculateROI(battery);
            const rates = getRates();
            const recommended = roiData.find(r => r.is_recommended);
            
            if (!recommended) return;
            
            const tenYearReturn = (recommended.annual_savings * 10) - recommended.battery_cost;
            const tenYearROI = ((tenYearReturn / recommended.battery_cost) * 100).toFixed(0);
            const savingsPerKwh = (rates.usage - rates.feedIn) * 100; // In cents
            
            document.getElementById('roi-insight').innerHTML = `
                <h4>üí° Financial Summary</h4>
                <p>With your rates (${(rates.feedIn * 100).toFixed(1)}c feed-in, ${(rates.peak * 100).toFixed(1)}c peak, ${(rates.offpeak * 100).toFixed(1)}c off-peak), each kWh shifted from export to self-use saves <strong>${savingsPerKwh.toFixed(1)}c</strong>.</p>
                <p style="margin-top: 0.75rem;">A <strong>${recommended.size_kwh} kWh battery</strong> at ~$${recommended.battery_cost.toLocaleString()} would:</p>
                <ul style="margin: 0.75rem 0; padding-left: 1.5rem; color: var(--text-secondary);">
                    <li>Save <strong style="color: var(--accent-export);">$${recommended.annual_savings.toFixed(0)}/year</strong> on electricity</li>
                    <li>Pay for itself in <strong style="color: var(--accent-sun);">${recommended.payback_years.toFixed(1)} years</strong></li>
                    <li>Generate <strong style="color: var(--accent-export);">$${tenYearReturn.toFixed(0)} net profit</strong> over 10 years (${tenYearROI}% ROI)</li>
                </ul>
                <p style="font-size: 0.85rem; margin-top: 0.75rem; opacity: 0.8;">
                    üìä Assumes 60% peak / 40% off-peak evening usage mix. Adjust rates above and click Update.
                </p>
            `;
        }

        function updateROIAnalysis() {
            if (!currentBatteryData) return;
            renderROITable(currentBatteryData);
            renderPaybackChart(currentBatteryData);
            renderCumulativeSavingsChart(currentBatteryData);
            renderROIInsight(currentBatteryData);
        }

        // ROI Update button
        document.getElementById('update-roi-btn').addEventListener('click', updateROIAnalysis);

        // Trends chart toggle (rolling avg vs daily)
        document.getElementById('trends-toggle').addEventListener('change', (e) => {
            if (trendsData.daily && trendsData.rolling) {
                renderTrendsChart(trendsData, e.target.checked ? 'daily' : 'rolling');
            }
        });
        
        // Battery simulation size selector
        document.getElementById('sim-battery-size').addEventListener('change', (e) => {
            if (globalDailyData) {
                renderBatterySimulation(globalDailyData, parseInt(e.target.value));
            }
        });

        // Date Range button
        document.getElementById('apply-date-range').addEventListener('click', () => {
            const startInput = document.getElementById('date-start').value;
            const endInput = document.getElementById('date-end').value;
            
            if (!startInput || !endInput) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (startInput > endInput) {
                alert('Start date must be before end date');
                return;
            }
            
            dateRange.start = startInput;
            dateRange.end = endInput;
            loadData(true);
        });

        // Auto-load if we already have data
        {% if has_data %}
        document.addEventListener('DOMContentLoaded', loadData);
        {% endif %}
    </script>
</body>
</html>

